name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.2.0)'
        required: true
        type: string
      draft:
        description: 'Create draft release? (true = draft, false = publish)'
        required: false
        type: boolean
        default: true

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: 'Release'

permissions:
  contents: write
  actions: write

jobs:
  build:
    name: Build Release Artifacts
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete old artifacts to free storage quota
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Cleaning up old artifacts..."
          $artifacts = gh api repos/${{ github.repository }}/actions/artifacts --jq '.artifacts[] | select(.expired == false) | .id' 2>$null
          if ($artifacts) {
            foreach ($id in $artifacts) {
              Write-Host "Deleting artifact $id..."
              gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$id 2>$null
            }
            Write-Host "Deleted $($artifacts.Count) artifacts"
          } else {
            Write-Host "No artifacts to delete"
          }

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore HelloID.Vault.Management.sln

      - name: Build solution
        run: dotnet build HelloID.Vault.Management.sln --configuration ${{ env.CONFIGURATION }} --no-restore

      - name: Build HelloID.PostgreSQL wrapper DLL
        run: |
          Write-Host "Building HelloID.PostgreSQL wrapper..." -ForegroundColor Cyan
          Set-Location connectors/HelloID.PostgreSQL
          ./build.ps1
          Set-Location ../..

      - name: Create PostgreSQL wrapper ZIP
        run: |
          Write-Host "Creating HelloID.PostgreSQL.zip..." -ForegroundColor Cyan
          Compress-Archive -Path connectors/HelloID.PostgreSQL/bin/Release/HelloID.PostgreSQL.dll -DestinationPath HelloID.PostgreSQL.zip

      - name: Upload PostgreSQL wrapper artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloID.PostgreSQL
          path: HelloID.PostgreSQL.zip

      - name: Build HelloID.SQLite wrapper DLL
        run: |
          Write-Host "Building HelloID.SQLite wrapper..." -ForegroundColor Cyan
          Set-Location connectors/HelloID.SQLite
          ./build.ps1
          Set-Location ../..

      - name: Create SQLite wrapper ZIP
        run: |
          Write-Host "Creating HelloID.SQLite.zip..." -ForegroundColor Cyan
          Set-Location connectors/HelloID.SQLite/bin/Release
          Compress-Archive -Path HelloID.SQLite.dll, runtimes -DestinationPath ../../../HelloID.SQLite.zip
          Set-Location ../../..

      - name: Upload SQLite wrapper artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloID.SQLite
          path: HelloID.SQLite.zip

      - name: Publish self-contained EXE (x64)
        run: dotnet publish src/HelloID.Vault.Management/HelloID.Vault.Management.csproj --configuration ${{ env.CONFIGURATION }} --runtime win-x64 --self-contained true --output publish/win-x64

      - name: Copy db folder to publish directory
        run: |
          New-Item -Path "publish/win-x64/db" -ItemType Directory -Force | Out-Null
          Copy-Item -Path "db/sqlite_schema.sql" -Destination "publish/win-x64/db/sqlite_schema.sql" -Force
          if (Test-Path "vault.json") {
            Copy-Item -Path "vault.json" -Destination "publish/win-x64/db/vault.json" -Force
          }

      - name: Remove language resource folders
        run: |
          Get-ChildItem -Path "publish/win-x64" -Directory | Where-Object { $_.Name -match '^[a-z]{2}(-[A-Z]{2})?$' -and $_.Name -ne 'db' } | Remove-Item -Recurse -Force

      - name: Verify db folder contents
        run: |
          Write-Host "=== Verifying db folder ==="
          if (Test-Path "publish/win-x64/db") {
            Get-ChildItem -Path "publish/win-x64/db" -Recurse | ForEach-Object { Write-Host "File: $($_.FullName.Substring((Get-Location).Path.Length + 1))" }
          } else {
            Write-Host "ERROR: db folder not found!"
          }

      - name: Create ZIP archive (x64)
        run: Compress-Archive -Path publish/win-x64/* -DestinationPath HelloID.Vault.Management-win-x64.zip

      - name: Upload artifacts (x64)
        uses: actions/upload-artifact@v4
        with:
          name: HelloID.Vault.Management-win-x64
          path: HelloID.Vault.Management-win-x64.zip

      - name: Install WiX CLI v6
        run: dotnet tool install --global wix --version 6.0.2

      - name: Create WiX configuration file
        run: |
          # Get version from workflow input and strip 'v' prefix if present
          $version = "${{ inputs.version }}"
          $version = $version -replace "^v", ""

          # Get all files from publish directory (recursive for db folder)
          $files = Get-ChildItem -Path "publish/win-x64" -Recurse -File
          $fileXml = ""
          $guidIndex = 100
          $publishDir = Get-Item "publish/win-x64"

          foreach ($file in $files) {
            $fileName = $file.Name
            # Use relative path from current directory for Source
            $sourcePath = $file.FullName.Substring((Get-Location).Path.Length + 1).Replace('\', '/')
            $relativePath = $file.FullName.Substring($publishDir.FullName.Length + 1).Replace('\', '/')
            $subdirectory = ""

            # Check if file is in a subdirectory
            if ($relativePath.Contains("/")) {
              $subdirectory = $relativePath.Substring(0, $relativePath.LastIndexOf("/"))
              $subdirectory = $subdirectory.Replace("/", "\")
            }

            if ($fileName -eq "HelloID.Vault.Management.exe" -and $relativePath -eq "HelloID.Vault.Management.exe") {
              $fileXml += "                <Component Id=`"MainExecutable`" Guid=`"*`">`n"
              $fileXml += "                  <File Source=`"$sourcePath`" KeyPath=`"yes`" Checksum=`"yes`"/>`n"
              $fileXml += "                </Component>`n"
            } elseif ($subdirectory -ne "") {
              $fileXml += "                <Component Id=`"File_$guidIndex`" Guid=`"*`" Subdirectory=`"$subdirectory`">`n"
              $fileXml += "                  <File Source=`"$sourcePath`" Name=`"$fileName`" />`n"
              $fileXml += "                </Component>`n"
            } else {
              $fileXml += "                <Component Id=`"File_$guidIndex`" Guid=`"*`">`n"
              $fileXml += "                  <File Source=`"$sourcePath`" Name=`"$fileName`" />`n"
              $fileXml += "                </Component>`n"
            }
            $guidIndex++
          }

          @"
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
            <Package Name="HelloID Vault Management"
                     Manufacturer="HelloID"
                     Version="$version"
                     UpgradeCode="6B8FA84C-3E2A-4F8E-9B5F-1E2D3C4A5B6C">

              <MediaTemplate EmbedCab="yes" />

              <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />

              <Feature Id="MainFeature" Title="HelloID Vault Management" Level="1">
                <ComponentGroupRef Id="ProductComponents" />
                <ComponentGroupRef Id="Shortcuts" />
              </Feature>

            </Package>

            <Fragment>
              <StandardDirectory Id="ProgramFiles64Folder">
                <Directory Id="INSTALLFOLDER" Name="HelloID.Vault.Management" />
              </StandardDirectory>
              <StandardDirectory Id="ProgramMenuFolder" />
            </Fragment>

            <Fragment>
              <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
          $fileXml
              </ComponentGroup>
            </Fragment>

            <Fragment>
              <ComponentGroup Id="Shortcuts" Directory="ProgramMenuFolder">
                <Component Id="StartMenuShortcut" Guid="*">
                  <Shortcut Id="ApplicationStartMenuShortcut"
                            Name="HelloID Vault Management"
                            Description="HelloID Vault Management Application"
                            Target="[INSTALLFOLDER]HelloID.Vault.Management.exe"
                            WorkingDirectory="INSTALLFOLDER" />
                  <RemoveFolder Id="CleanUpShortCut" Directory="ProgramMenuFolder" On="uninstall" />
                  <RegistryValue Root="HKCU" Key="Software\HelloID\VaultManagement" Name="installed" Type="integer" Value="1" KeyPath="yes" />
                </Component>
              </ComponentGroup>
            </Fragment>

          </Wix>
          "@ | Out-File -FilePath HelloID.Vault.Management.wxs -Encoding UTF8

      - name: Build MSI installer
        run: |
          $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
          wix build HelloID.Vault.Management.wxs -arch x64 -out HelloID.Vault.Management.msi

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloID.Vault.Management.msi
          path: HelloID.Vault.Management.msi

      - name: Verify tag exists
        shell: bash
        run: |
          TAG="${{ inputs.version }}"
          echo "Checking if tag ${TAG} exists..."

          # Fetch all tags from remote
          git fetch --tags origin

          # Check if tag exists locally or remotely
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "✅ Tag ${TAG} found"
          else
            echo "❌ Error: Tag ${TAG} does not exist!"
            echo ""
            echo "Please create the tag first:"
            echo "  git tag ${TAG}"
            echo "  git push origin ${TAG}"
            exit 1
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version }}
          files: |
            HelloID.Vault.Management-win-x64.zip
            HelloID.Vault.Management.msi
            HelloID.PostgreSQL.zip
            HelloID.SQLite.zip
          draft: ${{ inputs.draft }}
          prerelease: false
          name: ${{ inputs.version }}
          body: |
            ## Release ${{ inputs.version }}

            ### Installation Options

            **MSI Installer (Recommended for easy installation):**
            Download `HelloID.Vault.Management.msi` for automated installation with Start Menu shortcut.

            **ZIP Archive:**
            Download `HelloID.Vault.Management-win-x64.zip` for portable use.

            **PostgreSQL Wrapper DLL:**
            Download `HelloID.PostgreSQL.zip` for the PostgreSQL connection wrapper used by HelloID connectors.

            **SQLite Wrapper DLL:**
            Download `HelloID.SQLite.zip` for the SQLite connection wrapper used by HelloID connectors.

            ### Installation Instructions

            **MSI Installer:**
            1. Download `HelloID.Vault.Management.msi`
            2. Double-click to install
            3. Launch from Start Menu under "HelloID Vault Management"

            **ZIP Archive:**
            1. Download `HelloID.Vault.Management-win-x64.zip`
            2. Extract to a folder of your choice
            3. Run `HelloID.Vault.Management.exe`

            **PostgreSQL Wrapper:**
            1. Download `HelloID.PostgreSQL.zip`
            2. Extract `HelloID.PostgreSQL.dll` to your HelloID SourceData folder
            3. Required for PostgreSQL/Supabase target system connectors

            **SQLite Wrapper:**
            1. Download `HelloID.SQLite.zip`
            2. Extract `HelloID.SQLite.dll` to your HelloID SourceData folder
            3. Required for SQLite target system connectors (Microsoft.Data.Sqlite)

            ### Requirements

            - Windows 10 or later (64-bit)
            - .NET 8.0 Runtime (included in self-contained package)

            ### Changelog

            See the [commit history](https://github.com/${{ github.repository }}/commits/${{ inputs.version }}) for changes in this release.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}