name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: 'Release'

permissions:
  contents: write

jobs:
  build:
    name: Build Release Artifacts
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore HelloID.Vault.Management.sln

      - name: Build solution
        run: dotnet build HelloID.Vault.Management.sln --configuration ${{ env.CONFIGURATION }} --no-restore

      - name: Publish self-contained EXE (x64)
        run: dotnet publish src/HelloID.Vault.Management/HelloID.Vault.Management.csproj --configuration ${{ env.CONFIGURATION }} --runtime win-x64 --self-contained true --output publish/win-x64 -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true


      - name: Create ZIP archive (x64)
        run: Compress-Archive -Path publish/win-x64/* -DestinationPath HelloID.Vault.Management-win-x64.zip

      - name: Upload artifacts (x64)
        uses: actions/upload-artifact@v4
        with:
          name: HelloID.Vault.Management-win-x64
          path: HelloID.Vault.Management-win-x64.zip

      - name: Install WiX Toolset v3
        run: choco install wixtoolset -y --no-progress

      - name: Create WiX configuration file
        run: |
          # Get all files from publish directory
          $files = Get-ChildItem -Path "publish/win-x64" -File
          $fileXml = ""
          $guidIndex = 100

          foreach ($file in $files) {
            $fileName = $file.Name
            $filePath = $file.FullName.Replace('\', '/')

            if ($fileName -eq "HelloID.Vault.Management.exe") {
              $fileXml += "                <Component Id=`"MainExecutable`" Guid=`"*`" Win64=`"yes`">`n"
              $fileXml += "                  <File Source=`"$filePath`" KeyPath=`"yes`" Checksum=`"yes`"/>`n"
              $fileXml += "                </Component>`n"
            } else {
              $fileXml += "                <Component Id=`"File_$guidIndex`" Guid=`"*`" Win64=`"yes`">`n"
              $fileXml += "                  <File Source=`"$filePath`"/>`n"
              $fileXml += "                </Component>`n"
            }
            $guidIndex++
          }

          @"
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
            <Product Id="*"
                     Name="HelloID Vault Management"
                     Manufacturer="HelloID"
                     Version="1.0.0.0"
                     UpgradeCode="6B8FA84C-3E2A-4F8E-9B5F-1E2D3C4A5B6C"
                     Language="1033"
                     Platform="x64">

              <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />

              <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />

              <MediaTemplate EmbedCab="yes" />

              <Feature Id="MainFeature" Title="HelloID Vault Management" Level="1">
                <ComponentGroupRef Id="ProductComponents" />
                <ComponentGroupRef Id="Shortcuts" />
              </Feature>

            </Product>

            <Fragment>
              <Directory Id="TARGETDIR" Name="SourceDir">
                <Directory Id="ProgramFiles64Folder">
                  <Directory Id="INSTALLFOLDER" Name="HelloID Vault Management" />
                </Directory>
                <Directory Id="ProgramMenuFolder" />
              </Directory>
            </Fragment>

            <Fragment>
              <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
          $fileXml
              </ComponentGroup>
            </Fragment>

            <Fragment>
              <ComponentGroup Id="Shortcuts" Directory="ProgramMenuFolder">
                <Component Id="StartMenuShortcut" Guid="*" Win64="yes">
                  <Shortcut Id="ApplicationStartMenuShortcut"
                            Name="HelloID Vault Management"
                            Description="HelloID Vault Management Application"
                            Target="[INSTALLFOLDER]HelloID.Vault.Management.exe"
                            WorkingDirectory="INSTALLFOLDER" />
                  <RemoveFolder Id="CleanUpShortCut" Directory="ProgramMenuFolder" On="uninstall" />
                  <RegistryValue Root="HKCU" Key="Software\HelloID\VaultManagement" Name="installed" Type="integer" Value="1" KeyPath="yes" />
                </Component>
              </ComponentGroup>
            </Fragment>

          </Wix>
          "@ | Out-File -FilePath HelloID.Vault.Management.wxs -Encoding UTF8

      - name: Build MSI installer
        run: |
          candle HelloID.Vault.Management.wxs
          light -out HelloID.Vault.Management.msi HelloID.Vault.Management.wixobj

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloID.Vault.Management.msi
          path: HelloID.Vault.Management.msi

      - name: Get version from tag
        id: get_version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          $version = "${{ github.ref }}" -replace "refs/tags/", ""
          Add-Content -Path $env:GITHUB_OUTPUT -Value "version=$version"

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            HelloID.Vault.Management-win-x64.zip
            HelloID.Vault.Management.msi
          draft: false
          prerelease: false
          name: HelloID.Vault.Management ${{ steps.get_version.outputs.version }}
          body: |
            ## Release ${{ steps.get_version.outputs.version }}

            ### Installation Options

            **Windows x64 (Recommended):**
            Download `HelloID.Vault.Management-win-x64.zip` for 64-bit Windows systems.

            **MSI Installer (Recommended for easy installation):**
            Download `HelloID.Vault.Management.msi` for automated installation with Start Menu shortcut.

            ### Installation Instructions

            **ZIP Archive:**
            1. Download `HelloID.Vault.Management-win-x64.zip`
            2. Extract to a folder of your choice
            3. Run `HelloID.Vault.Management.exe`

            **MSI Installer:**
            1. Download `HelloID.Vault.Management.msi`
            2. Double-click to install
            3. Launch from Start Menu under "HelloID Vault Management"

            ### Requirements

            - Windows 10 or later (64-bit)
            - .NET 8.0 Runtime (included in self-contained package)
            
            ### Changelog
            
            See the [commit history](https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.version }}) for changes in this release.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
