name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: 'Release'

permissions:
  contents: write
  actions: write

jobs:
  build:
    name: Build Release Artifacts
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Delete old artifacts to free storage quota
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Cleaning up old artifacts..."
          $artifacts = gh api repos/${{ github.repository }}/actions/artifacts --jq '.artifacts[] | select(.expired == false) | .id' 2>$null
          if ($artifacts) {
            foreach ($id in $artifacts) {
              Write-Host "Deleting artifact $id..."
              gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$id 2>$null
            }
            Write-Host "Deleted $($artifacts.Count) artifacts"
          } else {
            Write-Host "No artifacts to delete"
          }

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore HelloID.Vault.Management.sln

      - name: Build solution
        run: dotnet build HelloID.Vault.Management.sln --configuration ${{ env.CONFIGURATION }} --no-restore

      - name: Publish self-contained EXE (x64)
        run: dotnet publish src/HelloID.Vault.Management/HelloID.Vault.Management.csproj --configuration ${{ env.CONFIGURATION }} --runtime win-x64 --self-contained true --output publish/win-x64

      - name: Copy db folder to publish directory
        run: |
          New-Item -Path "publish/win-x64/db" -ItemType Directory -Force | Out-Null
          Copy-Item -Path "db/sqlite_schema.sql" -Destination "publish/win-x64/db/sqlite_schema.sql" -Force
          if (Test-Path "vault.json") {
            Copy-Item -Path "vault.json" -Destination "publish/win-x64/db/vault.json" -Force
          }

      - name: Remove language resource folders
        run: |
          Get-ChildItem -Path "publish/win-x64" -Directory | Where-Object { $_.Name -match '^[a-z]{2}(-[A-Z]{2})?$' -and $_.Name -ne 'db' } | Remove-Item -Recurse -Force

      - name: Verify db folder contents
        run: |
          Write-Host "=== Verifying db folder ==="
          if (Test-Path "publish/win-x64/db") {
            Get-ChildItem -Path "publish/win-x64/db" -Recurse | ForEach-Object { Write-Host "File: $($_.FullName.Substring((Get-Location).Path.Length + 1))" }
          } else {
            Write-Host "ERROR: db folder not found!"
          }

      - name: Create ZIP archive (x64)
        run: Compress-Archive -Path publish/win-x64/* -DestinationPath HelloID.Vault.Management-win-x64.zip

      - name: Upload artifacts (x64)
        uses: actions/upload-artifact@v4
        with:
          name: HelloID.Vault.Management-win-x64
          path: HelloID.Vault.Management-win-x64.zip

      - name: Get version from tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          $version = "${{ github.ref }}" -replace "refs/tags/", ""
          $version = $version -replace "^v", ""
          Add-Content -Path $env:GITHUB_ENV -Value "VERSION=$version"

      - name: Install WiX CLI v6
        run: dotnet tool install --global wix --version 6.0.2

      - name: Create WiX configuration file
        run: |
          # Get version from environment or use default
          $version = "${{ env.VERSION }}"
          if (-not $version) { $version = "1.0.0.0" }

          # Get all files from publish directory (recursive for db folder)
          $files = Get-ChildItem -Path "publish/win-x64" -Recurse -File
          $fileXml = ""
          $guidIndex = 100
          $publishDir = Get-Item "publish/win-x64"

          foreach ($file in $files) {
            $fileName = $file.Name
            # Use relative path from current directory for Source
            $sourcePath = $file.FullName.Substring((Get-Location).Path.Length + 1).Replace('\', '/')
            $relativePath = $file.FullName.Substring($publishDir.FullName.Length + 1).Replace('\', '/')
            $subdirectory = ""

            # Check if file is in a subdirectory
            if ($relativePath.Contains("/")) {
              $subdirectory = $relativePath.Substring(0, $relativePath.LastIndexOf("/"))
              $subdirectory = $subdirectory.Replace("/", "\")
            }

            if ($fileName -eq "HelloID.Vault.Management.exe" -and $relativePath -eq "HelloID.Vault.Management.exe") {
              $fileXml += "                <Component Id=`"MainExecutable`" Guid=`"*`">`n"
              $fileXml += "                  <File Source=`"$sourcePath`" KeyPath=`"yes`" Checksum=`"yes`"/>`n"
              $fileXml += "                </Component>`n"
            } elseif ($subdirectory -ne "") {
              $fileXml += "                <Component Id=`"File_$guidIndex`" Guid=`"*`" Subdirectory=`"$subdirectory`">`n"
              $fileXml += "                  <File Source=`"$sourcePath`" Name=`"$fileName`" />`n"
              $fileXml += "                </Component>`n"
            } else {
              $fileXml += "                <Component Id=`"File_$guidIndex`" Guid=`"*`">`n"
              $fileXml += "                  <File Source=`"$sourcePath`" Name=`"$fileName`" />`n"
              $fileXml += "                </Component>`n"
            }
            $guidIndex++
          }

          @"
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
            <Package Name="HelloID Vault Management"
                     Manufacturer="HelloID"
                     Version="$version"
                     UpgradeCode="6B8FA84C-3E2A-4F8E-9B5F-1E2D3C4A5B6C">

              <MediaTemplate EmbedCab="yes" />

              <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />

              <Feature Id="MainFeature" Title="HelloID Vault Management" Level="1">
                <ComponentGroupRef Id="ProductComponents" />
                <ComponentGroupRef Id="Shortcuts" />
              </Feature>

            </Package>

            <Fragment>
              <StandardDirectory Id="ProgramFiles64Folder">
                <Directory Id="INSTALLFOLDER" Name="HelloID.Vault.Management" />
              </StandardDirectory>
              <StandardDirectory Id="ProgramMenuFolder" />
            </Fragment>

            <Fragment>
              <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
          $fileXml
              </ComponentGroup>
            </Fragment>

            <Fragment>
              <ComponentGroup Id="Shortcuts" Directory="ProgramMenuFolder">
                <Component Id="StartMenuShortcut" Guid="*">
                  <Shortcut Id="ApplicationStartMenuShortcut"
                            Name="HelloID Vault Management"
                            Description="HelloID Vault Management Application"
                            Target="[INSTALLFOLDER]HelloID.Vault.Management.exe"
                            WorkingDirectory="INSTALLFOLDER" />
                  <RemoveFolder Id="CleanUpShortCut" Directory="ProgramMenuFolder" On="uninstall" />
                  <RegistryValue Root="HKCU" Key="Software\HelloID\VaultManagement" Name="installed" Type="integer" Value="1" KeyPath="yes" />
                </Component>
              </ComponentGroup>
            </Fragment>

          </Wix>
          "@ | Out-File -FilePath HelloID.Vault.Management.wxs -Encoding UTF8

      - name: Build MSI installer
        run: |
          $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
          wix build HelloID.Vault.Management.wxs -arch x64 -out HelloID.Vault.Management.msi

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloID.Vault.Management.msi
          path: HelloID.Vault.Management.msi

      - name: Get version from tag
        id: get_version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          $version = "${{ github.ref }}" -replace "refs/tags/", ""
          Add-Content -Path $env:GITHUB_OUTPUT -Value "version=$version"

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            HelloID.Vault.Management-win-x64.zip
            HelloID.Vault.Management.msi
          draft: false
          prerelease: false
          name: ${{ steps.get_version.outputs.version }}
          body: |
            ## Release ${{ steps.get_version.outputs.version }}

            ### Installation Options

            **Windows x64 (Recommended):**
            Download `HelloID.Vault.Management-win-x64.zip` for 64-bit Windows systems.

            **MSI Installer (Recommended for easy installation):**
            Download `HelloID.Vault.Management.msi` for automated installation with Start Menu shortcut.

            ### Installation Instructions

            **ZIP Archive:**
            1. Download `HelloID.Vault.Management-win-x64.zip`
            2. Extract to a folder of your choice
            3. Run `HelloID.Vault.Management.exe`

            **MSI Installer:**
            1. Download `HelloID.Vault.Management.msi`
            2. Double-click to install
            3. Launch from Start Menu under "HelloID Vault Management"

            ### Requirements

            - Windows 10 or later (64-bit)
            - .NET 8.0 Runtime (included in self-contained package)
            
            ### Changelog
            
            See the [commit history](https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.version }}) for changes in this release.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
